<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!-- Import bootstrap dependencies-->
    <link rel="stylesheet" href="/vendor/bootstrap/bootstrap.min.css" />
    <script src="/vendor/bootstrap/jquery-3.5.1.min.js"></script>
    <script src="/vendor/bootstrap/popper.min.js"></script>
    <script src="/vendor/bootstrap/bootstrap.min.js"></script>

    <script>
      var _tooltip = jQuery.fn.tooltip;
    </script>
    <!-- <script src="/vendor/bootstrap/jquery-ui.min.js"></script>-->
    <script>
      jQuery.fn.tooltip = _tooltip;
    </script>

    <!-- Import bootstrap dependencies-->

    <!-- <link rel="stylesheet" href="/stylesheets/fontwasome.all.css" /> -->

    <script src="/vendor/sweetalert/sweetalert2.js"></script>
    <link rel="stylesheet" href="/vendor/sweetalert/sweetalert2.css" />

    <!-- Import full calendar local dependencies-->
    <script src="/vendor/full-calendar/moment.min.js"></script>
    <!--<link rel="stylesheet" href="/vendor/full-calendar/main.css" />-->
    <!--<link rel="stylesheet" href="/vendor/full-calendar/daygrid_main.css"/>-->
    <!--<link rel="stylesheet" href="/vendor/full-calendar/timegrid_main.css"/>-->

    <!-- Import chart.js  dependencies-->
    <script src="/vendor/chart.js/Chart.min.js"></script>

    <!-- Import datatables local dependencies-->
    <link
      rel="stylesheet"
      type="text/css"
      href="/vendor/data-tables/datatables.min.css"
    />
    <!--<script type="text/javascript" src="/vendor/data-tables/pdfmake.min.js"></script> -->
    <!--<script type="text/javascript" src="/vendor/data-tables/vfs_fonts.js"></script> -->
    <script
      type="text/javascript"
      src="/vendor/data-tables/datatables.min.js"
    ></script>
    <script
      type="text/javascript"
      src="/vendor/data-tables/datetime-moment.js"
    ></script>

    <link
      rel="stylesheet"
      href="/vendor/data-tables/searchBuilder.bootstrap4.min.css"
    />
    <script src="/vendor/data-tables/dataTables.searchBuilder.min.js"></script>

    <!-- Import flatpicker calendar local dependencies-->
    <link rel="stylesheet" href="/vendor/flat-picker/flatpickr.min.css" />
    <link rel="stylesheet" href="/vendor/flat-picker/airbnb.css" />
    <script src="/vendor/flat-picker/flatpickr.js"></script>
    <script src="/vendor/flat-picker/es.js"></script>

    <title>Ingreso Productos</title>
  </head>
  <body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark py-3">
      <div class="container">
        <a class="navbar-brand" href="/inicio">
          <img src="images/logo.png" width="60" height="60" alt="" />
        </a>
        <button
          class="navbar-toggler"
          type="button"
          data-toggle="collapse"
          data-target="#navbarNav"
          aria-controls="navbarNav"
          aria-expanded="false"
          aria-label="Toggle navigation"
        >
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
          <ul class="navbar-nav">
            <li class="nav-item">
              <a class="nav-link" href="/inicio">Inicio</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/inventario">Inventario</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/venta">Nueva Venta</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/producto">Ingreso Producto</a>
            </li>
            <li class="nav-item dropdown">
              <a
                class="nav-link dropdown-toggle"
                href="#"
                id="navbarDropdown"
                role="button"
                data-toggle="dropdown"
                aria-haspopup="true"
                aria-expanded="false"
              >
                Históricos
              </a>
              <div class="dropdown-menu" aria-labelledby="navbarDropdown">
                <a class="dropdown-item" href="/historico_ventas">Ventas</a>
                <a class="dropdown-item" href="/cliente">Base clientes</a>
              </div>
            </li>
            <li class="nav-item">
              <p class="nav-link mr-3">
                <strong> Usuario : <%= usuario %> </strong>
              </p>
            </li>
            <li class="nav-item">
              <button
                type="button"
                class="btn btn-outline-info btn-sm mt-1"
                id="logout"
              >
                Cerrar Sesión
              </button>
            </li>
          </ul>
        </div>
      </div>
    </nav>
    <div class="container my-3 p-3 bg-light border shadow-sm p-3">
      <form>
        <div>
          <h1 class="font-weight-light ml-3">Ingreso Producto Nuevo</h1>
          <div class="col-md-12">
            <div class="form-group">
              <label for="exampleInputEmail1">Código</label>
              <input type="text" class="form-control" id="codigo_producto" />
            </div>
            <div class="form-group">
              <label for="exampleInputEmail1">Descripción</label>
              <input
                type="text"
                class="form-control"
                id="descripcion_producto"
              />
            </div>
            <div class="form-group">
              <label for="exampleInputEmail1">Costo unitario</label>
              <input type="number" class="form-control" id="costo_producto" />
            </div>
            <div class="form-group">
              <label for="exampleInputEmail1">Precio de venta unitario</label>
              <input
                type="number"
                class="form-control"
                id="precio_venta_producto"
              />
            </div>
          </div>
        </div>
        <button
          type="submit"
          class="btn btn-primary ml-3"
          id="btn_crear_producto"
        >
          <strong>Registrar Producto</strong>
        </button>
      </form>
    </div>

    <div class="table-responsive container border shadow-sm">
      <div class="d-flex justify-content-between mt-4">
        <h1 class="font-weight-light">Productos Ingresados</h1>
        <div class="text-right ml-3 my-3">
          <button
            type="submit"
            class="btn btn-outline-primary"
            id="hide-filter"
          >
            <strong>Mostrar Filtros</strong>
          </button>
        </div>
      </div>
      <table
        id="table-producto"
        class="table-data table table-hover table-bordered bg-white text-center"
      ></table>
    </div>

    <nav class="navbar navbar-light bg-dark mt-5">
      <a class="navbar-brand" href="#">
        <img src="images/logo.png" width="60" height="60" alt="" />
      </a>
    </nav>

    <!-- Modal editar Producto -->

    <div
      class="modal fade"
      id="ModalEditarProducto"
      tabindex="-1"
      role="dialog"
      aria-labelledby=""
      aria-hidden="true"
    >
      <div
        class="modal-dialog modal-dialog-centered mw-90 h-70"
        role="document"
      >
        <div class="modal-content">
          <div class="modal-header text-white bg-primary">
            <h5 class="modal-title">
              <i class="far fa-clipboard"></i> &nbsp;&nbsp; Editar Producto
            </h5>
            <button
              type="button"
              class="close"
              data-dismiss="modal"
              aria-label="Close"
            >
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <div class="row">
              <div class="col-md-12 mb-2">
                <div class="card shadow-sm h-100">
                  <div class="card-body">
                    <form>
                      <div class="form-group">
                        <label for="inputAddress">Descripción</label>
                        <input
                          type="text"
                          class="form-control"
                          id="descripcion_producto_editar"
                          placeholder="Descripción Producto"
                        />
                      </div>
                      <div class="form-group d-none">
                        <input
                          type="text"
                          class="form-control"
                          id="codigo_producto_editar"
                          value=""
                        />
                      </div>
                      <div class="form-row">
                        <div class="form-group col-md-6">
                          <label for="inputCity">Costo</label>
                          <input
                            type="text"
                            class="form-control"
                            id="costo_producto_editar"
                            placeholder="$"
                          />
                        </div>
                        <div class="form-group col-md-6">
                          <label for="inputEmail4">Precio Venta</label>
                          <input
                            type="text"
                            class="form-control"
                            id="precio_venta_producto_editar"
                            placeholder="$"
                          />
                        </div>
                      </div>
                      <button
                        type="button"
                        onClick="ActualizarProducto()"
                        class="btn btn-primary"
                      >
                        Actualizar
                      </button>
                    </form>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal igresar cantidad  Producto -->

    <div
      class="modal fade"
      id="ModalIngresarCantidad"
      tabindex="-1"
      role="dialog"
      aria-labelledby=""
      aria-hidden="true"
    >
      <div
        class="modal-dialog modal-dialog-centered mw-90 h-70"
        role="document"
      >
        <div class="modal-content">
          <div class="modal-header text-white bg-primary">
            <h5 class="modal-title">
              <i class="far fa-clipboard"></i> &nbsp;&nbsp; Editar Producto
            </h5>
            <button
              type="button"
              class="close"
              data-dismiss="modal"
              aria-label="Close"
            >
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <div class="row">
              <div class="col-md-12 mb-2">
                <div class="card shadow-sm h-100">
                  <div class="card-body">
                    <form>
                      <div class="form-group">
                        <label for="inputAddress">Descripción</label>
                        <input
                          type="text"
                          class="form-control"
                          id="descripcion_producto_cantidad"
                          placeholder="Descripción Producto"
                          readonly
                        />
                      </div>
                      <div class="form-group d-none">
                        <input
                          type="text"
                          class="form-control"
                          id="codigo_producto_cantidad"
                        />
                      </div>
                      <div class="form-row">
                        <div class="form-group col-md-6">
                          <label for="inputCity">Costo</label>
                          <input
                            type="text"
                            class="form-control"
                            id="costo_producto_cantidad"
                            placeholder="$"
                            readonly
                          />
                        </div>
                        <div class="form-group col-md-6">
                          <label for="inputEmail4">Precio Venta</label>
                          <input
                            type="text"
                            class="form-control"
                            id="precio_venta_producto_cantidad"
                            placeholder="$"
                            readonly
                          />
                        </div>
                      </div>
                      <div class="form-group">
                        <label for="inputAddress">Cantidad</label>
                        <input
                          type="number"
                          class="form-control"
                          id="cantidad_producto"
                          placeholder="Cantidad de producto que ingresa"
                        />
                      </div>
                      <button
                        type="button"
                        onClick="IngresarCantidadProducto()"
                        class="btn btn-primary"
                      >
                        Ingresar
                      </button>
                    </form>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </body>

  <script>
    function CreateTableProducto() {
      var base_url = window.location.origin;
      if ($.fn.dataTable.isDataTable("#table-producto")) {
        table = $("#table-producto").DataTable();
        table.destroy();
      }
      var table = $("#table-producto").DataTable({
        ajax: {
          url: base_url + "/producto/productos",
          dataSrc: "",
        },
        columns: [
          {
            data: "codigo",
            title: "Código",
            width: "50px",
            searchPanes: { show: false },
          },
          {
            data: "descripcion",
            title: "Descripción",
            width: "300px",
            searchPanes: { show: false },
          },
          {
            data: "costo",
            title: "Costo",
            width: "100px",
            searchPanes: { show: true },
          },
          {
            data: "precio_venta",
            title: "Precio Venta",
            width: "120px",
            searchPanes: { show: true },
          },
          {
            data: "cantidad",
            title: "Existencias",
            width: "80px",
            searchPanes: { show: true },
          },
          {
            data: "codigo",
            title: "Acciones",
            width: "180px",
            searchPanes: { show: false },
          },
          {
            data: "_id",
            title: "id",
            width: "180px",
            searchPanes: { show: false },
            visible: false,
          },
        ],
        language: {
          url: "/vendor/data-tables/Spanish.json",
        },
        select: false,
        scrollX: true,
        responsive: false,
        pageLength: 5,
        dom: "PlfrtiBp",
        order: [[0, "desc"]],

        columnDefs: [
          {
            render: function (data, type, row) {
              return "$" + new Intl.NumberFormat().format(data);
            },
            targets: [2, 3],
          },
          {
            render: function (data, type, row) {
              return (
                '<button class="btn btn-outline-primary btn-guardar btn-sm" onClick="ingresarCantidad(' +
                data +
                ')"><b>Ingresar</b></button>&nbsp;&nbsp;<button class="btn btn-outline-secondary btn-guardar btn-sm" onClick="ActualizarProductoModal(' +
                data +
                ')"><b>Editar</b></button>'
              );
            },
            targets: [5],
          },
        ],
      });
    }

    CreateTableProducto();

    $(document).ready(function () {
      setTimeout(function () {
        $(".dtsp-container").addClass("d-none");
        $(".buttons-copy").addClass("d-none");
        $(".buttons-csv").addClass("d-none");
      }, 200);
    });

    $("#hide-filter").click(function () {
      $(".dtsp-container").toggleClass("d-none");

      $("#hide-filter").toggleClass("active");

      if ($("#hide-filter strong").text() == "Ocultar Filtros") {
        $("#hide-filter").html(
          '<strong>Mostrar Filtros</strong>&nbsp;&nbsp;<i class="fas fa-filter"></i>'
        );
      } else {
        $("#hide-filter").html(
          '<strong>Ocultar Filtros</strong>&nbsp;&nbsp;<i class="fas fa-filter"></i>'
        );
      }
    });

    function GuardarNuevoProducto() {
      let data = {
        codigo: $("#codigo_producto").val(),
        descripcion: $("#descripcion_producto").val(),
        cantidad: 0,
        costo: $("#costo_producto").val(),
        precio_venta: $("#precio_venta_producto").val(),
      };

      if (
        $("#codigo_producto").val() == "" ||
        $("#descripcion_producto").val() == "" ||
        $("#costo_producto").val() == "" ||
        $("#precio_venta_producto").val() == ""
      ) {
        Swal.fire(
          "Información",
          "Todos los campos son obligatorios.",
          "warning"
        );
      } else {
        $.ajax({
          method: "POST",
          url: "/producto",
          data: data,
        }).done(function (result) {
          Swal.fire("Información", "¡Datos guardados exitosamente!", "success");
          // CreateTableProducto()
        });
      }
    }

    function ActualizarProducto() {
      let data = {
        codigo: $("#codigo_producto_editar").val(),
        descripcion: $("#descripcion_producto_editar").val(),
        costo: $("#costo_producto_editar").val(),
        precio_venta: $("#precio_venta_producto_editar").val(),
      };

      if (
        $("#codigo_producto_editar").val() == "" ||
        $("#descripcion_producto_editar").val() == "" ||
        $("#costo_producto_editar").val() == "" ||
        $("#precio_venta_producto_editar").val() == ""
      ) {
        Swal.fire(
          "Información",
          "Todos los campos son obligatorios.",
          "warning"
        );
      } else {
        id = data.codigo;
        $.ajax({
          method: "PUT",
          url: "producto/productos/" + id,
          data: data,
        }).done(function (result) {
          Swal.fire("Información", "¡Datos guardados exitosamente!", "success");
          let table = $("#table-producto").DataTable();
          table.ajax.reload();
        });
      }
    }

    function IngresarCantidadProducto() {
      let data = {
        codigo: $("#codigo_producto_cantidad").val(),
        descripcion: $("#descripcion_producto_cantidad").val(),
        costo: $("#costo_producto_cantidad").val(),
        precio_venta: $("#precio_venta_producto_cantidad").val(),
        cantidad: $("#cantidad_producto").val(),
      };

      if (
        $("#codigo_producto_cantidad").val() == "" ||
        $("#descripcion_producto_cantidad").val() == "" ||
        $("#costo_producto_cantidad").val() == "" ||
        $("#precio_venta_producto_cantidad").val() == "" ||
        $("#cantidad_producto").val() == ""
      ) {
        Swal.fire(
          "Información",
          "Todos los campos son obligatorios.",
          "warning"
        );
      } else {
        id = data.codigo;
        $.ajax({
          method: "PUT",
          url: "producto/productos_cantidad/" + id,
          data: data,
        }).done(function (result) {
          Swal.fire("Información", "¡Datos guardados exitosamente!", "success");

          $("#cantidad_producto").val("");
          // setTimeout(() => {
          //   location.reload();
          // }, 1000);
          let table = $("#table-producto").DataTable();
          table.ajax.reload();
        });
      }
    }

    $("#btn_crear_producto").on("click", function (e) {
      e.preventDefault();
      GuardarNuevoProducto();
    });

    function ActualizarProductoModal(cod) {
      var table = $("#table-producto").DataTable();

      var indexes = table
        .rows()
        .eq(0)
        .filter(function (rowIdx) {
          return table.cell(rowIdx, 0).data() == cod ? true : false;
        });

      var data = table.rows(indexes).data();
      $("#descripcion_producto_editar").val(data[0].descripcion);
      $("#codigo_producto_editar").val(data[0]._id);
      $("#costo_producto_editar").val(data[0].costo);
      $("#precio_venta_producto_editar").val(data[0].precio_venta);

      $("#ModalEditarProducto").modal();
    }

    function ingresarCantidad(cod) {
      var table = $("#table-producto").DataTable();

      var indexes = table
        .rows()
        .eq(0)
        .filter(function (rowIdx) {
          return table.cell(rowIdx, 0).data() == cod ? true : false;
        });

      var data = table.rows(indexes).data();
      $("#descripcion_producto_cantidad").val(data[0].descripcion);
      $("#codigo_producto_cantidad").val(data[0]._id);
      $("#costo_producto_cantidad").val(data[0].costo);
      $("#precio_venta_producto_cantidad").val(data[0].precio_venta);

      $("#ModalIngresarCantidad").modal();
    }
    function limpiarStorage() {
      localStorage.clear();
      location.reload();
    }

    $("#logout").on("click", function () {
      limpiarStorage();
      $.ajax({
        method: "POST",
        url: "auth/logout",
      }).done(function (result) {
        setTimeout(() => {
          location.reload();
        }, 200);
      });
    });
  </script>
</html>
